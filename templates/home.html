<!DOCTYPE html>
<html lang="en">
<head>
    <title>RFID Key Log</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/home.css') }}">
    <!-- <script src="{{ url_for('static', filename='script.js') }}" defer></script> -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    
</head>
<body>
    <div class="header">
        <img src="{{ url_for('static', filename='KGLOGO.jpg') }}" alt="Logo">
        <div>
            <h1>KGiSL Institute of Technology</h1>
            <p>An Autonomous Institution | Saravanampatti, Coimbatore, Tamil Nadu</p>
        </div>
        <a href="{{ url_for('logout') }}" class="lg-out">
        👤 {{ user.username }} | Logout
        </a>
    </div>

    <div class="container">
        <center><h2>RFID Key Log</h2></center>
        
        <form id="rfid-form">
            <label for="security" style="color: white;">Security RFID:</label>
            <input type="text" id="security_rfid" placeholder="Scan Security RFID">

            <label for="staff"  style="color: white;">Faculty RFID:</label>
            <input type="text" id="staff" oninput="fetchStaffName()" placeholder=" Scan Staff RFID">

            <label for="rfid"  style="color: white;">Key RFID:</label>
            <input type="text" id="rfid" placeholder="Scan Key RFID">
            <p id="staff-name"></p>

            <button type="submit">Submit</button>
        </form>

        <p class="message">{{ message }}</p>
        <button id="database-button" onclick="window.location.href='/database'">Go to Database</button>
    </div>

    <div class="footer">
        © 2025 IPS Tech Community. All Rights Reserved.
    </div>

    <script>

        // Function to fetch staff name based on RFID input
        fetch('/home', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(rfidData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Handle success
                document.getElementById('message').innerHTML = data.message;
                document.getElementById('message').style.color = '#00ff00';
            } else {
                // Handle error
                document.getElementById('message').innerHTML = data.message;
                document.getElementById('message').style.color = '#ff4444';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('message').innerHTML = '⚠️ Network error occurred!';
        });


        document.addEventListener("DOMContentLoaded", function () {
            const form = document.getElementById("rfid-form");
            const staffInput = document.getElementById("staff");
            const securityInput = document.getElementById("security_rfid");
            const labInput = document.getElementById("rfid");
            const staffNameDisplay = document.getElementById("staff-name");
    
            // Prevent form submission on Enter key press in input fields
            form.addEventListener("keydown", function (event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                }
            });
    
            // Fetch staff name based on RFID input
            staffInput.addEventListener("input", async function () {
                let rfid = staffInput.value.trim();
    
                if (rfid.length > 3) {  // Ensure valid input length
                    try {
                        let response = await fetch("/get_staff_name", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ rfid: rfid })
                        });
    
                        let data = await response.json();
    
                        if (response.ok) {
                            staffNameDisplay.innerText = `Staff Name: ${data.name}`;
                        } else {
                            throw new Error(data.error || "Failed to fetch staff name");
                        }
                    } catch (error) {
                        console.error("Error fetching staff name:", error);
                        staffNameDisplay.innerText = " ";
                    }
                } else {
                    staffNameDisplay.innerText = "";
                }
            });
    
            // Handle form submission
            form.addEventListener("submit", async function (event) {
                event.preventDefault(); // Prevent default form submission
    
                let security_rfid = securityInput.value.trim();
                let staff_rfid = staffInput.value.trim();
                let lab_rfid = labInput.value.trim();
    
                if (!security_rfid || !staff_rfid || !lab_rfid) {
                    Swal.fire({
                        icon: "error",
                        title: "Oops...",
                        text: "❌ Please enter all RFID details!"
                    });
                    return;
                }
    
                try {
                    let response = await fetch("/home", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ security: security_rfid, staff: staff_rfid, rfid: lab_rfid })
                    });
    
                    let data = await response.json();
    
                    if (response.ok) {
                        Swal.fire({
                            icon: "success",
                            title: "Success",
                            text: data.message
                        });
                        form.reset(); // Clear form after successful submission
                        staffNameDisplay.innerText = ""; // Clear staff name display
                    } else {
                        throw new Error(data.error || "Submission failed");
                    }
                } catch (error) {
                    console.error("Error submitting RFID:", error);
                    Swal.fire({
                        icon: "error",
                        title: "Submission Failed",
                        text: "❌ Something went wrong, please try again!"
                    });
                }
            });
        });
        
        // CSRF token for AJAX requests
        function getCSRFToken() {
            return document.querySelector('meta[name=csrf-token]').getAttribute('content');
        }

        // Enhanced AJAX with CSRF protection
        function submitRFIDData(formData) {
            fetch('/home', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                // Handle response
                console.log(data);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        // Session management
        let lastActivity = Date.now();
        let sessionTimeout = 30 * 60 * 1000; // 30 minutes

        // Update last activity on user interaction
        document.addEventListener('click', () => lastActivity = Date.now());
        document.addEventListener('keypress', () => lastActivity = Date.now());

        // Check session timeout
        setInterval(function() {
            if (Date.now() - lastActivity > sessionTimeout) {
                alert("Session expired due to inactivity. You will be logged out.");
                window.location.href = "/logout";
            }
        }, 60000); // Check every minute
</script>

</body>
</html>
